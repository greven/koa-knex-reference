#!/usr/bin/env node

const program = require('commander')
const { prompt } = require('inquirer')
const uuid = require('uuid')
const bcrypt = require('bcrypt')
const chalk = require('chalk')
const knex = require('knex')
const config = require('../server/config')
const regex = require('../lib/regex')
const { omit } = require('../lib/objects')
const {
  prettyPrintObject,
  prettyPrintArrayOfObjects
} = require('../lib/utils')

const {
  createUser,
  getAllUsers
} = require('../server/api/users/queries')

// Migrations
const createMigrations = function () {
  const db = knex(config.db)
  db.migrate.latest()
}

// -- Questions ------------------------------

const questions = {
  createUser: [
    {
      type: 'input',
      name: 'email',
      message: 'Enter email address ..',
      validate: email => {
        return regex.email.test(email)
      }
    },
    {
      type: 'password',
      name: 'password',
      message: 'Enter password ..'
    },
    {
      type: 'password',
      name: 'passwordConfirm',
      message: 'Re-enter password ..'
    }
  ]
}

// -- Command Line Interface ------------------------------

program
  .version(require('../package').version)
  .usage('<command>')
  .description('CLI to interface with the API')

// Create a User
program
  .command('createUser <username>')
  .description('Create a new user')
  .action(async (username) => {
    prompt(questions.createUser).then(async (answers) => {
      await createMigrations()
      let user = answers
      user.username = username

      if (answers.password !== answers.passwordConfirm) {
        console.log(chalk.red('Passwords don\'t match!'))
      } else {
        user.id = uuid()
        user.password = await bcrypt.hash(user.password, 12)
        try {
          user = omit(user, ['passwordConfirm'])
          await createUser(user)
          prettyPrintObject(user, 'User created')
        } catch (error) {
          console.log(chalk.red(error))
        }
      }
    })
  })

// List all users
program
  .command('listUsers')
  .description('List all the users')
  .action(async () => {
    try {
      await createMigrations()
      const users = await getAllUsers()
      prettyPrintArrayOfObjects(users, ['password', 'created_at', 'updated_at'])
      console.log(chalk.bold.blue('  Total: ') + chalk.bold(users.length) + ' users\n')
    } catch (error) {
      console.log(chalk.red(error))
    }
  })

program.parse(process.argv)
